# Last Modified: Fri Mar 31 20:05:05 2017
#include <tunables/global>

/usr/bin/dockerd {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  capability chown,
  capability dac_override,
  capability fsetid,
  capability net_admin,
  capability net_raw,
  capability sys_admin,
  capability sys_module,
  capability sys_resource,

  / r,
  /.pivot_root*/ w,
  /Dockerfile w,
  /Makefile* w,
  /bin/kmod mr,
  /bin/kmod rix,
  /conf/ w,
  /conf/fonts.conf w,
  /data.stage/docker/git/** r,
  /data.stage/docker/local/ w,
  /data.stage/docker/local/** rwk,
  /dev/dm-[0-9] rw,
  /dev/loop* rw,
  /dev/loop-control r,
  /dev/mapper/control rw,
  /dev/zfs rw,
  /etc/apparmor.d/ r,
  /etc/apparmor.d/cache/ r,
  /etc/apparmor.d/cache/.features r,
  /etc/apparmor.d/docker rw,
  /etc/apparmor/parser.conf r,
  /etc/dfs/sharetab r,
  /etc/docker/certs.d/** r,
  /etc/docker/certs.d/** r,
  /etc/docker/key.json r,
  /etc/hosts r,
  /etc/modprobe.d/ r,
  /etc/modprobe.d/*.conf r,
  /etc/os-release r,
  /etc/resolv.conf r,
  /etc/udev/udev.conf r,
  /run/blkid/ rw,
  /run/blkid/* rwl,
  /run/docker.pid w,
  /run/docker.sock w,
  /run/docker/ rw,
  /run/docker/** rw,
  /sbin/apparmor_parser Cx,
  /sbin/apparmor_parser mr,
  /sbin/blkid Cx,
  /sbin/xtables-multi mr,
  /sbin/xtables-multi rix,
  /sbin/zfs mr,
  /sbin/zfs rix,
  /sbin/zpool Cx,
  /sys/devices/system/cpu/ r,
  /sys/devices/virtual/block/dm-** r,
  /sys/fs/cgroup/cpuset/cpuset.cpus r,
  /sys/fs/cgroup/cpuset/cpuset.mems r,
  /sys/kernel/security/apparmor/profiles r,
  /sys/module/apparmor/parameters/enabled r,
  /sys/module/bridge/initstate r,
  /sys/module/ipv6/initstate r,
  /sys/module/llc/initstate r,
  /sys/module/nf_conntrack/initstate r,
  /sys/module/nf_nat/initstate r,
  /sys/module/stp/initstate r,
  /sys/module/x_tables/initstate r,
  /sys/module/xfrm_algo/initstate r,
  /sys/module/xfrm_user/initstate r,
  /sys/module/xt_conntrack/initstate r,
  /temp-docker-extract*/ w,
  /usr/bin/containerd Cx,
  /usr/bin/dockerd mr,
  /usr/bin/dockerd rix,
  /usr/bin/runc rix,
  /usr/bin/tini rix,
  /var/cache/docker/ w,
  /var/cache/docker/** rwk,
  @{PROC}/ r,
  @{PROC}/*/cgroup r,
  @{PROC}/*/fd/ r,
  @{PROC}/*/mountinfo r,
  @{PROC}/*/mounts r,
  @{PROC}/*/net/ip_tables_names r,
  @{PROC}/*/oom_score_adj w,
  @{PROC}/*/uid_map r,
  @{PROC}/cmdline r,
  @{PROC}/devices r,
  @{PROC}/stat r,
  @{PROC}/sys/kernel/cap_last_cap r,
  @{PROC}/sys/kernel/hostname r,
  @{PROC}/sys/kernel/keys/root_maxkeys r,
  @{PROC}/sys/kernel/modprobe r,
  @{PROC}/sys/kernel/threads-max r,
  @{PROC}/sys/net/bridge/bridge-nf-call-ip6tables r,
  @{PROC}/sys/net/bridge/bridge-nf-call-iptables r,
  @{PROC}/sys/net/core/somaxconn r,
  @{PROC}/sys/net/ipv4/ip_forward rw,
  @{PROC}/sys/net/ipv4/ip_local_port_range r,


  profile /sbin/apparmor_parser {
    #include <abstractions/base>

    capability mac_admin,

    /etc/apparmor.d/ r,
    /etc/apparmor.d/** rw,
    /etc/apparmor/parser.conf r,
    /sbin/apparmor_parser mr,
    /sys/devices/system/cpu/ r,
    /sys/kernel/security/apparmor/ r,
    /sys/kernel/security/apparmor/** r,
    /sys/kernel/security/apparmor/.replace w,
    @{PROC}/*/mounts r,
    @{PROC}/sys/kernel/osrelease r,

  }

  profile /sbin/blkid {
    #include <abstractions/base>

    /dev/dm-* r,
    /run/blkid/ w,
    /run/blkid/* rwl,
    /sbin/blkid mr,
    /sys/devices/virtual/block/dm-*/ r,
    /sys/devices/virtual/block/dm-*/dm/uuid r,

  }

  profile /sbin/zpool {
    #include <abstractions/base>

    /dev/zfs rw,
    /etc/dfs/sharetab r,
    /sbin/zpool mr,
    @{PROC}/*/mounts r,

  }

  profile /usr/bin/containerd {
    #include <abstractions/base>

    /run/docker/libcontainerd/ rw,
    /run/docker/libcontainerd/** rw,
    /usr/bin/containerd mr,
    /usr/bin/containerd-shim rix,
    /usr/bin/runc rix,
    @{PROC}/meminfo r,
    @{PROC}/stat r,
    @{PROC}/sys/net/core/somaxconn r,

  }
}
